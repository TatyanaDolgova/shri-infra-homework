name: Deploy Release to Production

on:
  workflow_dispatch:
    inputs:
      release_version:
        description: "Release version"
        required: true

jobs:
  deploy_to_production:
    runs-on: ubuntu-latest

    steps:
      - name: Log in to Yandex Cloud Container Registry
        run: |
          docker login \
            --username oauth \
            --password "${{ secrets.YANDEX_REGISTRY_TOKEN }}" \
            cr.yandex

      - name: Check Docker image existence in Yandex Container Registry
        run: |
          if ! docker pull cr.yandex/${{ secrets.YANDEX_REGISTRY_ID }}/app:${{ github.event.inputs.release_version }}_latest; then
            echo "Error: Docker image cr.yandex/${{ secrets.YANDEX_REGISTRY_ID }}/app:${{ github.event.inputs.release_version }}_latest not found."
            exit 1
          fi

      - name: Deploy Docker image to VM via SSH
        run: |
          docker stop app || true
          docker rm app || true
          docker pull cr.yandex/${{ secrets.YANDEX_REGISTRY_ID }}/app:${{ github.event.inputs.release_version }}_latest
          docker run -d --name app -p 3000:3000 cr.yandex/${{ secrets.YANDEX_REGISTRY_ID }}/app:${{ github.event.inputs.release_version }}_latest

      - name: Find related issue
        id: find_issue
        run: |
          issue_number=$(gh issue list --search "Release ${{ github.event.inputs.release_version }}" --json number --jq '.[0].number')
          echo "Found issue number: $issue_number"
          echo "ISSUE_NUMBER=$issue_number" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare comment body
        id: prepare_comment
        run: |
          comment="##Релиз выкачан в прод##"
          comment+=" - Дата: $(date --utc +'%Y-%m-%dT%H:%M:%SZ') "
          comment+=" - Автор: ${{ github.actor }} "
          echo "$comment" > issue_comment.md
          echo "COMMENT_BODY=$(cat issue_comment.md)" >> $GITHUB_ENV
