name: Deploy Release to Production

on:
  workflow_dispatch:
    inputs:
      release_version:
        description: "Release version"
        required: true

jobs:
  deploy_to_production:
    runs-on: ubuntu-latest

    steps:
      - name: Check Docker image existence in Yandex Container Registry
        run: |
          if ! docker pull cr.yandex/${{ secrets.YANDEX_REGISTRY_ID }}/app:${{ github.event.inputs.release_version }}_latest; then
            echo "Error: Docker image cr.yandex/${{ secrets.YANDEX_REGISTRY_ID }}/app:${{ github.event.inputs.release_version }}_latest not found."
            exit 1
          fi

      - name: Deploy Docker image to VM via SSH
        uses: appleboy/ssh-action@master
        with:
          script_stop: true
          script: |
            docker stop app || true
            docker rm app || true
            docker pull cr.yandex/${{ secrets.YANDEX_REGISTRY_ID }}/app:${{ github.event.inputs.release_version }}_latest
            docker run -d --name app -p 80:80 cr.yandex/${{ secrets.YANDEX_REGISTRY_ID }}/app:${{ github.event.inputs.release_version }}_latest

      - name: Add comment to GitHub issue
        run: |
          echo "Release ${{ github.event.inputs.release_version }} deployed to production on $(date) by ${{ github.actor }}" > comment.txt
          gh issue comment ${{ github.event_path }} -b "$(cat comment.txt)"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
