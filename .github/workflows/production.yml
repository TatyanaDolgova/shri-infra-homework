name: Deploy Release to Production

on:
  workflow_dispatch:
    inputs:
      release_version:
        description: "Release version"
        required: true

jobs:
  deploy_to_production:
    runs-on: ubuntu-latest

    steps:
      - name: Log in to Yandex Cloud Container Registry
        run: |
          docker login \
            --username oauth \
            --password "${{ secrets.YANDEX_REGISTRY_TOKEN }}" \
            cr.yandex

      - name: Check Docker image existence in Yandex Container Registry
        run: |
          if ! docker pull cr.yandex/${{ secrets.YANDEX_REGISTRY_ID }}/app:${{ github.event.inputs.release_version }}_latest; then
            echo "Error: Docker image cr.yandex/${{ secrets.YANDEX_REGISTRY_ID }}/app:${{ github.event.inputs.release_version }}_latest not found."
            exit 1
          fi

      - name: Deploy Docker image to VM via SSH
        run: |
          docker stop app || true
          docker rm app || true
          docker pull cr.yandex/${{ secrets.YANDEX_REGISTRY_ID }}/app:${{ github.event.inputs.release_version }}_latest
          docker run -d --name app -p 3000:3000 cr.yandex/${{ secrets.YANDEX_REGISTRY_ID }}/app:${{ github.event.inputs.release_version }}_latest

      - name: Add comment to GitHub issue
        run: |
          ISSUE_NUMBER=$(jq --raw-output .issue.number "$GITHUB_EVENT_PATH")
          COMMENT="Release ${{ github.event.inputs.release_version }} deployed to production on $(date --utc +'%Y-%m-%dT%H:%M:%SZ') by ${{ github.actor }}"
          echo "$COMMENT" > comment.txt
          gh issue comment $ISSUE_NUMBER -F comment.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
